
## Google Cloud Memorystore for Redis のベスト プラクティス


### maxmemoryポリシーを指定する（済）
Redisインスタンスのメモリが上限に達した状態で新しい書き込みが発生すると、エラーになる。

エラーを回避するため、インスタンスのmaxmemoryポリシー設定し、Redisがキーのエビクションを行い、ポリシーに基づいて書き込み用にスペースを確保できるようにすることが推奨されている

Memorystore for Redisのデフォルトのmaxmemoryポリシーは volatile-lruとなっており、キーセット全体から、最も長い間使用されていない（LRU）キーを削除する動作となる

※ttyが設定されていないキーは削除対象にならないので注意

### Memorystore for Redis v6以上を使う（済）
バージョン6以上を実行しているすべてのインスタンスではI/Oマルチスレッドが有効になり、複数のvCPUを使用してI/Oを同時に処理できるようになり、インスタンスのスループットが向上する

### リードレプリカを使う
プライマリインスタンスに障害が発生した場合はレプリカに自動的にフェイルオーバーします。
リードレプリカはデフォルトでは有効になっていません。

リードレプリカを使用することにより。読み取りスループットが線形に拡張される。プライマリインスタンスがダウンした場合はフェイルオーバーが発生しリードレプリカ用のインスタンスがプライマリとなる。(新しいプライマリが読み取りと書き込みの両方で使用できるようになる)なお、フェイルオーバーには一般的に20〜30秒かかるとされている

### RDBスナップショットを作成する
事前定義された間隔でスナップショットを自動的に取得し、必要に応じてそこか復元できるので、データの耐久性を高めることができる

### アラートを設定
メモリ、CPUそれぞれCloud Monitoringでしきい値を設定し、しきい値に基づいて問題が発生したときに通知できるようにしておくことが推奨されている。

#### メモリ使用率
80%のメモリ使用率のしきい値に維持することが推奨とされている

#### CPU使用率
90%のCPU使用率のしきい値を維持することが推奨とされている

メインスレッド CPU 秒（redis.googleapis.com/stats/cpu_utilization_main_thread）指標にアラートを設定し、CPU 使用率がプライマリノードで 0.9 秒、各レプリカノードで 0.5 秒を超えないようにすることが推奨されている

### モニタリング設定
Cloud Monitoringのcallから確認できる

### メンテナンス時間を設定する（済）
Memorystoreはフルマネージドサービスのため、バッチ適用などインスタンスを自動的に適用するが、アプリケーションの使用量のピーク時にメンテナンスが発生することを防ぐため、あらかじめ夜間などに実行されるようにスケジュール設定しておくことが推奨されている

なお、メンテナンスの開始時に、システムメモリ使用率メト​​リックが 50%未満である必要がある点も注意


#### メンテナンス通知をオプトインする(済)
インスタンスのメンテナンス更新がスケジュールされる少なくとも 7日前に電子メールでアラートを受けるメンテナンス通知をオプトインする必要がある（デフォルトOFFのため）

設定→通信→Memorystoreの行で、メールボタンを [オン] に切り替える


### 参考
https://dataintegration.info/google-cloud-memorystore-for-redis-best-practices-tips-for-a-highly-performant-and-worry-free-deployment